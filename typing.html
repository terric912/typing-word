<!DOCTYPE html>
<html lang="zh-hant-tw">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="Author" content="Terric Chen, terric_AT_gmail_com">
	<title>英打遊戲</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
	<style>
		body {
			font-family: Consolas, Verdana, Arial, sans-serif;
		}
		#board {
			position: relative;
		}
		.word {
			position: absolute;
			background-color: salmon;
			padding: 0px 10px;
			margin: 5px;
		}
	</style>
</head>
<body onload="init();" onresize="calcBH();">
	<div class="card vh-100">
		<div class="card-header fs-4">
			Time:<span id="time">0</span>s &emsp;&emsp; Score:<span id="score">0</span>
			<span id="wordCount"> &emsp;&emsp; Words:<span id="countTotal">0/0</span>
				<button class="btn btn-sm btn-danger" id="btnStop" onclick="gameStop();"><i class="bi bi-power"></i></button>
			</span>
			<div class="d-inline-flex float-end">
				<button class="btn btn-sm btn-warning mx-1" data-bs-toggle="modal" data-bs-target="#modalSettings"><i class="bi bi-gear"></i></button>
			</div>
		</div>
		<div class="card-body bg-primary-subtle" id="board"></div>
		<div class="card-footer text-body-secondary"><div class="row">
			<div class="col-12 col-sm-9 col-md-6">
				<input type="text" id="input" class="form-control form-control-lg" placeholder="在此輸入，按Enter送出" onchange="mykey(this);">
			</div>
		</div></div>
		<div class="toast-container d-flex justify-content-center vh-100 vw-100">
			<div class="toast align-self-center" data-bs-autohide="false">
				<div class="d-flex">
					<div class="toast-body fs-4" id="msg"></div>
					<button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast"></button>
				</div>
			</div>
		</div>
	</div>

	<div id="modalSettings" class="modal" tabindex="-1">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header"><h5 class="modal-title fw-bold">設定</h5></div>
				<div class="modal-body">
					<select class="form-select mb-2" onchange="gameLv=this.value;">
						<option value="0" selected disabled>請選擇題庫：</option>
						<option value="j1">國中基本單字(1229)</option>
						<option value="j2">國中進階單字(779)</option>
						<option value="s0">高中英單不分級(135)</option>
						<option value="s1">高中英單第一級(1047)</option>
						<option value="s2">高中英單第二級(1039)</option>
						<option value="s3">高中英單第三級(1018)</option>
						<option value="s4">高中英單第四級(1022)</option>
						<option value="s5">高中英單第五級(1006)</option>
						<option value="s6">高中英單第六級(1030)</option>
					</select>
					<div class="form-check form-switch form-check-inline">
						<input class="form-check-input" type="checkbox" id="cbBGM" oninput="toggleBGM(this);" checked>
						<label class="form-check-label">背景音樂 BGM</label>
						<input type="range" id="volBGM" min="0" max="1" step="0.05" oninput="get('bgm').volume=this.value;">
					</div>
					<div class="form-check form-switch">
						<input class="form-check-input" type="checkbox" id="cbSFX" checked>
						<label class="form-check-label">對錯音效 SFX</label>
					</div>
				</div>
				<div class="modal-footer" id="timeBtns">
					<button class="bTime btn btn-outline-primary" data-bs-dismiss="modal" onclick="gameStart(60);">1分鐘</button>
					<button class="bTime btn btn-outline-info" data-bs-dismiss="modal" onclick="gameStart(180);">3分鐘</button>
					<button class="bTime btn btn-outline-success" data-bs-dismiss="modal" onclick="gameStart(300);">5分鐘</button>
					<button class="bTime btn btn-outline-warning" data-bs-dismiss="modal" onclick="gameStart(600);">10分鐘</button>
					<button class="bTime btn btn-outline-danger" data-bs-dismiss="modal" onclick="gameStart(0);">不限時</button>
				</div>
			</div>
		</div>
	</div>

	<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
	<script>
		function get(id) { return document.getElementById(id); }
		function gets(qs) { return Array.from(document.querySelectorAll(qs)); }
		function getRnd(min,max) { return Math.floor(Math.random()*(max-min+1))+min; }
		function calcBH() { 
			var _css=getComputedStyle(get("board"));
			_bw=parseFloat(_css["width"]);
			_bh=parseFloat(_css["height"]);
		}
		function toggleBGM(cb) {
			if(get("bgm").paused && cb.checked && gameTime>0) {
				get("bgm").play();
			} else {
				get("bgm").pause();
			} 
		}
		function mykey(k) {
			var match=gets(".word").filter(function(o) { 
				return k.value.trim()==o.innerHTML;
			});
			if(match.length<=0) {
				if(get("cbSFX").checked) get("sfx_x").play();
			} else {
				if(get("cbSFX").checked) get("sfx_o").play();
				match.forEach(function(o) {
					get("score").innerHTML=(++gameScore);
					o.innerHTML=o.word.tc;
					o.style.background="transparent";
					setTimeout(remove,3000,o);
				});
			}
			k.value="";
		}
		function remove(x) {
			clearInterval(x.tmr);
			x.remove();
		}
		function falling(o) {
			o.y++;
			o.style.left=o.x+"px";
			o.style.top=o.y+"px";
			if(o.y+o.h >= _bh) remove(o);
		}
		function createWord() {
			var x = document.createElement("div");
			x.className="word";
			x.word=word.pop();
			x.innerHTML=x.word.en;
			x.w=x.innerHTML.length * 9 + 20;
			x.h=26;
			x.x=getRnd(0, _bw - x.w);
			x.y=0;
			x.style.left=x.x+"px";
			x.style.top=x.y+"px";
			x.tmr=setInterval(falling,100,x);
			get("board").append(x);
			get("countTotal").innerHTML=`${++wordCount}/${wordTotal}`;
			if($("#wordCount").is(":visible") && (wordTotal==wordCount)) {
				(w.innerHTML.length>12)?changeWords(0,0):(w.innerHTML.length<7)?changeWords(7,12):changeWords(13,18);
				wordCount=0;
			}
		}
		function gameStart(t) {
			if(gameLv==0) {
				alert("請先進行遊戲設定！");return;
			}
			calcBH();
			wordCount=0;
			gameScore=0;
			gameTime=t;
			get("score").innerHTML=0;
			get("time").innerHTML=t;
			get("input").focus();
			$("#timeBtns").hide();
			if(get("cbBGM").checked) get("bgm").play();
			if(t>0) {
				changeWords();
				$("#wordCount").hide();
				timeCount=t;
				gameTimer=setInterval(()=>{
					get("time").innerHTML=(--timeCount);
					if(timeCount<=0) gameStop();
				},1000);
			} else {
				changeWords(0,6);
				$("#btnStop").show();
				$("#wordCount").show();
				gameTimer=setInterval(()=>{
					get("time").innerHTML=(++gameTime);
				},1000);
			}
			wordTimer=setInterval(createWord,2000);
		}
		function gameStop() {
			clearInterval(wordTimer);
			clearInterval(gameTimer);
			if(get("cbBGM").checked) get("bgm").pause();
			gets(".word").forEach(function(o){remove(o);});
			get("msg").innerHTML=`恭喜你得了 ${gameScore} 分！`;
			$(".toast").toast("show");
			$("#timeBtns").show();
			$("#btnStop").hide();
			//TODO: RANK BOARD
		}
		function changeWords(m=0,n=0) {
			window.word=Array.from(window.words).filter(function(x) {
				var ret=(x.Lv==gameLv);
				if(m>0) ret&&=(x.en.length >= m);
				if(n>0) ret&&=(x.en.length <= n);
				return  ret;
			});
			window.word.sort(()=>{return 0.5-Math.random();});
			wordTotal=window.word.length;
			get("countTotal").innerHTML=`${wordCount}/${wordTotal}`;
		}
		function loadWords() {
			fetch("words.json").then(response => response.json())
				.then(data => {
					window.words = data.map(item => {
						return {en:item.en,Lv:item.Lv,tc:item.tc};
					});
				}).catch(error => {
					console.error('Error loading the JSON file:', error);
				});
			gameLv=0;
		}
		function init() {
			loadWords();
			get('volBGM').value=0.5;
			get('bgm').volume=get('volBGM').value;
			$("#input").on('blur',function() {
				$('.modal').hasClass('show') || get("input").focus();
			});
			$(".modal").on('hidden.bs.modal', function() {
				get("input").focus();
			});
			$("#wordCount").hide();
			$('#modalSettings').modal('show');
		}
	</script>
	<audio id="bgm" loop><source src="bgm.mp3" type="audio/mpeg"></audio>
	<audio id="sfx_o"><source src="sfx_o.mp3" type="audio/mpeg"></audio>
	<audio id="sfx_x"><source src="sfx_x.mp3" type="audio/mpeg"></audio>
</body>
</html>
