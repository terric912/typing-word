<!DOCTYPE html>
<html lang="zh-hant-tw">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="Author" content="Terric Chen, terric_AT_gmail_com">
	<title>英打遊戲</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
	<style>
		body {
			font-family: Consolas, Verdana, Arial, sans-serif;
		}
		#board {
			position: relative;
		}
		.word {
			position: absolute;
			background-color: salmon;
			padding: 0px 10px;
			margin: 5px;
		}
		mark {
			background: transparent;
			color:yellow;
		}
	</style>
</head>
<body onload="gameInit();" onresize="boardResize();">
	<div class="card vh-100">
		<div class="card-header fs-4">
			Time:<span id="time">0</span>s &emsp;&emsp; Score:<span id="score">0</span>
			<span id="wordCount"> &emsp;&emsp; Words:<span id="countTotal">0/0</span>
				<button class="btn btn-sm btn-danger" id="btnStop" onclick="gameStop();"><i class="bi bi-power"></i></button>
			</span>
			<div class="d-inline-flex float-end">
				<button class="btn btn-sm btn-warning mx-1" data-bs-toggle="modal" data-bs-target="#modalSettings"><i class="bi bi-gear"></i></button>
				<button class="btn btn-sm btn-success mx-1" data-bs-toggle="modal" data-bs-target="#modalRanks"><i class="bi bi-bar-chart"></i></button>
			</div>
		</div>
		<div class="card-body bg-primary-subtle" id="board"></div>
		<div class="card-footer text-body-secondary"><div class="row">
			<div class="col-12 col-sm-9 col-md-6">
				<input type="text" id="input" class="form-control form-control-lg" autocapitalize="off" placeholder="在此輸入，按Enter送出" onkeydown="mykeyDown(this);" onkeyup="mykeyUp(this);">
			</div>
		</div></div>
		<div class="toast-container d-flex justify-content-center vh-100 vw-100">
			<div class="toast text-bg-info align-self-center">
				<div class="d-flex">
					<div class="toast-body fs-4" id="msg"></div>
					<button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast"></button>
				</div>
			</div>
		</div>
	</div>

	<div id="modalSettings" class="modal" tabindex="-1">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header"><h5 class="modal-title fw-bold">設定</h5></div>
				<div class="modal-body">
					<select class="form-select mb-2" onchange="gameLv=this.value;">
						<option value="0" selected disabled>請選擇題庫：</option>
						<option value="j1">國中基本單字(1229)</option>
						<option value="j2">國中進階單字(779)</option>
						<option value="s0">高中英單不分級(135)</option>
						<option value="s1">高中英單第一級(1047)</option>
						<option value="s2">高中英單第二級(1039)</option>
						<option value="s3">高中英單第三級(1018)</option>
						<option value="s4">高中英單第四級(1022)</option>
						<option value="s5">高中英單第五級(1006)</option>
						<option value="s6">高中英單第六級(1030)</option>
					</select>
					<div class="form-check form-switch form-check-inline">
						<input class="form-check-input" type="checkbox" id="cbBGM" oninput="toggleBGM(this);" checked>
						<label class="form-check-label">背景音樂 BGM</label>
						<input type="range" id="volBGM" min="0" max="1" step="0.05" oninput="get('bgm').volume=this.value;">
					</div>
					<div class="form-check form-switch">
						<input class="form-check-input" type="checkbox" id="cbSFX" checked>
						<label class="form-check-label">對錯音效 SFX</label>
					</div>
				</div>
				<div class="modal-footer" id="timeBtns">
					<button class="bTime btn btn-outline-primary" data-bs-dismiss="modal" onclick="gameStart(60);">1分鐘</button>
					<button class="bTime btn btn-outline-info" data-bs-dismiss="modal" onclick="gameStart(180);">3分鐘</button>
					<button class="bTime btn btn-outline-success" data-bs-dismiss="modal" onclick="gameStart(300);">5分鐘</button>
					<button class="bTime btn btn-outline-warning" data-bs-dismiss="modal" onclick="gameStart(600);">10分鐘</button>
					<button class="bTime btn btn-outline-danger" data-bs-dismiss="modal" onclick="gameStart(0);">不限時</button>
				</div>
			</div>
		</div>
	</div>

	<div id="modalRanks" class="modal" tabindex="-1">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header"><h5 class="modal-title fw-bold">本機排行榜</h5></div>
				<dl class="modal-body" id="rankboard"></dl>
				<div class="modal-footer justify-content-between">
					<button class="btn btn-sm btn-outline-danger" data-bs-dismiss="modal" onclick="clearRank();">清除排行榜</button>
					<button class="btn btn-sm btn-outline-secondary" data-bs-dismiss="modal">關閉</button>
				</div>
			</div>
		</div>
	</div>

	<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
	<script>
		function get(id) { return document.getElementById(id); }
		function gets(qs) { return Array.from(document.querySelectorAll(qs)); }
		function getRnd(min,max) { return Math.floor(Math.random()*(max-min+1))+min; }
		function boardResize() {
			if(window.innerWidth < 768) {
				get("board").style.flexGrow="0.4";
			} else {
				get("board").style.flexGrow="";
			}
			var _css=getComputedStyle(get("board"));
			_bw=parseFloat(_css["width"]);
			_bh=parseFloat(_css["height"]);
		}
		function toggleBGM(cb) {
			if(get("bgm").paused && cb.checked && gameTime>0) {
				get("bgm").play();
			} else {
				get("bgm").pause();
			} 
		}
		function mykeyUp(k) {
			if(event.key === 'Enter') return;
			gets("mark").forEach(function(o){o.outerHTML=o.innerHTML;});
			gets(".word").filter(function(o) {
				return this.length && o.innerText.startsWith(this);
			}, k.value).forEach(function(o) {
				o.innerHTML=`<mark>${this}</mark>`+o.word.en.substr(this.length);
			}, k.value);
		}
		function mykeyDown(k) {
			if(event.key !== 'Enter') return;
			var match=false;
			gets(".word").filter(function(o) { 
				return this.trim()==o.innerText;
			}, k.value).forEach(function(o) {
				match=true;
				get("score").innerHTML=(++gameScore);
				o.innerHTML=o.word.tc;
				o.style.background="transparent";
				setTimeout(remove,3000,o);
			});
			if(get("cbSFX").checked) get(match?"sfx_o":"sfx_x").play();
			if(gameScore == wordCount && wordSpeed > 500) {
				wordSpeed-=100;
				clearInterval(wordTimer);
				wordTimer=setInterval(createWord,wordSpeed);
			}
			k.value="";
		}
		function remove(x) {
			clearInterval(x.tmr);
			x.remove();
		}
		function falling(o) {
			o.y++;
			o.style.left=o.x+"px";
			o.style.top=o.y+"px";
			if(o.y+o.h >= _bh) {
				word.unshift(o.word);
				wordCount--;
				remove(o);
			}
		}
		function createWord() {
			var x = document.createElement("div");
			x.className="word";
			x.word=word.pop();
			x.innerHTML=x.word.en;
			x.w=x.innerHTML.length * 9 + 20;
			x.h=26;
			x.x=getRnd(0, _bw - x.w);
			x.y=0;
			x.style.left=x.x+"px";
			x.style.top=x.y+"px";
			x.tmr=setInterval(falling,100,x);
			get("board").append(x);
			get("countTotal").innerHTML=`${++wordCount}/${wordTotal}`;
			if($("#wordCount").is(":visible") && (wordTotal==wordCount)) {
				(w.innerHTML.length>12)?changeWords(0,0):(w.innerHTML.length<7)?changeWords(7,12):changeWords(13,18);
				wordCount=0;
			}
		}
		function gameStart(t) {
			if(gameLv==0) {
				alert("請先進行遊戲設定！");return;
			}
			wordCount=0;
			gameScore=0;
			gameTime=t;
			get("score").innerHTML=0;
			get("time").innerHTML=t;
			get("input").focus();
			$("#timeBtns").hide();
			if(get("cbBGM").checked) get("bgm").play();
			if(t>0) {
				changeWords();
				$("#wordCount").hide();
				timeCount=t;
				gameTimer=setInterval(()=>{
					get("time").innerHTML=(--timeCount);
					if(timeCount<=0) gameStop();
				},1000);
			} else {
				changeWords(0,6);
				$("#btnStop").show();
				$("#wordCount").show();
				gameTimer=setInterval(()=>{
					get("time").innerHTML=(++gameTime);
				},1000);
			}
			wordSpeed=2000;
			wordTimer=setInterval(createWord,wordSpeed);
		}
		function gameStop() {
			clearInterval(wordTimer);
			clearInterval(gameTimer);
			if(get("cbBGM").checked) get("bgm").pause();
			gets(".word").forEach(function(o){remove(o);});
			get("msg").innerHTML=`恭喜你得了 ${gameScore} 分！`;
			$(".toast").toast("show");
			$("#timeBtns").show();
			$("#btnStop").hide();
			setRank();
		}
		function changeWords(m=0,n=0) {
			window.word=Array.from(window.words).filter(function(x) {
				var ret=(x.Lv==gameLv);
				if(m>0) ret&&=(x.en.length >= m);
				if(n>0) ret&&=(x.en.length <= n);
				return  ret;
			});
			window.word.sort(()=>{return 0.5-Math.random();});
			wordTotal=window.word.length;
			get("countTotal").innerHTML=`${wordCount}/${wordTotal}`;
		}
		function loadWords() {
			fetch("words.json").then(response => response.json())
				.then(data => {
					window.words = data.map(item => {
						return {en:item.en,Lv:item.Lv,tc:item.tc};
					});
				}).catch(error => {
					console.error('Error loading the JSON file:', error);
				});
			gameLv=0;
		}
		function gameInit() {
			gameLv=gameTime=gameScore=0;
			loadWords();
			get('volBGM').value=0.5;
			get('bgm').volume=get('volBGM').value;
			$("#input").on('blur',function() {
				$('.modal').hasClass('show') || get("input").focus();
			});
			$(".modal").on('hidden.bs.modal', function() {
				get("input").focus();
			});
			$("#wordCount").hide();
			$("#modalRanks").on('show.bs.modal',getRank);
			$('#modalSettings').modal('show');
			boardResize();
		}
		function getRank() {
			var LvTitle={"j1":"國中基本單字","j2":"國中進階單字","s0":"高中不分級","s1":"高中第一級","s2":"高中第二級","s3":"高中第三級","s4":"高中第四級","s5":"高中第五級","s6":"高中第六級"};
			var rank=null;
			get("rankboard").innerHTML="";
			if(localStorage.getItem("typing")) {
				rank=JSON.parse(localStorage.typing);
				for(var lv of Object.keys(rank).sort()) {
					var t=document.createElement("dt");
					t.innerHTML=LvTitle[lv];
					var o=document.createElement("ol");
					o.setAttribute("id","ol"+lv);
					for(var x of rank[lv]) {
						var y=document.createElement("li");
						var z=Number(x.score/(x.time/60)).toFixed(1);
						y.innerHTML=`${z} WPM, ${x.score} in ${x.time} seconds.`;
						if(x.score==gameScore && x.time==gameTime && lv==gameLv) y.className="text-danger";
						o.appendChild(y);
					};
					t.appendChild(o);
					get("rankboard").appendChild(t);
				};
			} else {
				get("rankboard").innerHTML="等你來挑戰！";
			}
		}
		function setRank() {
			var rank={};
			if(localStorage.getItem("typing")) {
				rank=JSON.parse(localStorage.typing);
			}
			if(Object.keys(rank).includes(gameLv)) {
				rank[gameLv].push({"score":gameScore,"time":gameTime});
				rank[gameLv].sort(function(a,b) {
					return (b.score/b.time)-(a.score/a.time);
				});
				if(rank[gameLv].length > 5) rank[gameLv].pop();
			} else {
				Object.defineProperty(rank, gameLv, {value:[{"score":gameScore,"time":gameTime}],writable:true,enumerable:true,configurable:true});
			}
			localStorage.setItem("typing",JSON.stringify(rank));
		}
		function clearRank() {
			localStorage.removeItem("typing");
		}
	</script>
	<audio id="bgm" loop><source src="bgm.mp3" type="audio/mpeg"></audio>
	<audio id="sfx_o"><source src="sfx_o.mp3" type="audio/mpeg"></audio>
	<audio id="sfx_x"><source src="sfx_x.mp3" type="audio/mpeg"></audio>
</body>
</html>
